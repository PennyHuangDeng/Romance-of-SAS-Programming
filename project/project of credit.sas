/*creat a library*/
libname ex 'D:\DATA ANALYSIS\sas documents\sas project\from wechat\Data&Code\Data';
data smbl;
set ex.smbl;
run;

/*check the info of data set*/
proc contents data=smbl;run;

/* look at the first rows of data set*/
proc print data=smbl(obs=5);run;

/*drop-duplicate*/
proc sql;
create table smbl1 as 
select distinct*
from smbl;
quit;

/*check missing value and mean etc*/
proc means data = ex.smbl N nmiss min mean median max std; 
      var _numeric_;
run;

/*the situation of each var*/
%macro FreqBar(ds, varname);/*data set =ds,var=varname*/
proc freq data=&ds;
tables &varname / plots(only)=freqplot;
run;
%mend;
%FreqBar(smbl, local)
%FreqBar(smbl,creditlevel )
%FreqBar(smbl, bad)
%FreqBar(smbl, education)
%FreqBar(smbl, indarea)
%FreqBar(smbl, reason) 
/*the 'reason' of missing value is higher */

/*???????????*/
/*????*/
proc freq data = smbl; 
  tables (reason creditlevel education indarea local)*bad/chisq nocol nopercent;/*norow nocol nopercent:?????????,???????????*/
run;
/*'reason' have two styles , good style almost equal bad style,and missing value is higher,
so ,if create model,we will not think about it*/

/*????*/
%macro plottrend(ds, varname,y, obsingroup);
data temp; *?????????????????;
  set &ds(keep = &varname  &y.);
run;

proc sort data = temp out = tmp;  *?????????;
  by &varname; 
run;

data tmp; *???????????????;
  set tmp; 
  group = ceil(_N_ /&obsingroup);
run;

data plot; *??????,??????????,????????????plot;
  set tmp; 
  by group;
  if first.group then 
    sum =0; 
  if last.group then do; 
    avg = (sum/&obsingroup); 
    output; 
    end; 
    else sum + &y.; 
run;

proc sgplot data = plot; *??;
  title"&varname - Bad Trend";
  series x= group y = avg / markers; 
run;
%mend;

%plottrend(smbl, age,bad, 1200)
%plottrend(smbl, yropen,bad, 600)
%plottrend(smbl, revenue,bad, 600)
%plottrend(smbl, rent,bad, 600)
%plottrend(smbl, debtinc,bad, 600)
%plottrend(smbl, delinq,bad, 600)      
%plottrend(smbl, profitrate,bad, 600)
%plottrend(smbl, creditage,bad,600)
%plottrend(smbl, storearea,bad,600)

/*????*/
/*?????
    ?????,?????,???,???,???,???,????;?????,?????,??,????
????????,?????????????,?????????????????,?????????8~10?????,
??????????????*/
proc means data = smbl n nmiss mean p90  ;
  var debtinc delinq creditage age revenue;
run;
/*?????????90???,???,??,??????*/
data smbl; 
  set smbl; 
  if (debtinc = . )then debtinc  = 41.78;
  if (delinq = .) then delinq = 2;
  if (creditage = .) then creditage =6.9;
  if (age = .) then age = 39;
  if (revenue = .) then revenue = 100349;
  drop indarea local reason;
run;

/*????*/
/*1??????????
    ??????????(?????)????????,????????????????,??????????????
    ???????,???????????,????????,?????????
2??????
    ????????,??????,???N???n???(???)?
    ???????????,??????,???N???n???(??)?
    ???????,????????????,1~N,???????n,?????K = N/n,?1~K?????i,????i+K,i+2K,????n??????
    ?????,??????????,?????????????
    ??????,?????,????????????????????????,?????????????*/
/*?????*/
/*????????*/
proc sql noprint; select count(ID) into: TotalObs from smbl ;quit;
%let train_obs = %sysevalf(0.7*&TotalObs); *????????;
%let validate_obs = %sysevalf(0.3*&TotalObs); *????????;
/*????*/
proc surveyselect data = smbl out = split seed = 9999
  group = (&train_obs, &validate_obs);
run;
/*??   */
/*?????*/
data smbl_train smbl_validate ;
  set split; 
  if GroupID =1 then do; 
    drop GroupID; 
    output smbl_train; 
  end;
  else do; 
    drop GroupID;
    output smbl_validate; 
  end;
run;

/*????*/
/*????0/1???,???????????????,????????????*/

proc logistic data = smbl_train desc ; 
  class creditlevel ;
  model bad = creditlevel delinq debtinc profitrate  revenue yropen /selection = none; 
run;
/*creditlevel2,pr 0.4334,?????????,????outdesign????????2???
??????*/


proc logistic data = smbl_train desc outdesign = work.design; 
  class creditlevel ;
  model bad = creditlevel delinq debtinc profitrate  revenue yropen /selection = none; 
run;
/*???????????,???????1?????3,???????????2???*/
proc logistic data = work.design desc outmodel = work.estimate1 ; /*outmodel??????*/
  model bad = creditlevel1 creditlevel3 delinq debtinc profitrate revenue yropen /selection = none; 
  score data= work.design out=scores1; /*score???????*/
run;
/*??????????*/

/*????*/
/*????????????????*/
proc logistic data = work.smbl_validate desc outdesign = work.design2; 
  class creditlevel ;
  model bad = creditlevel delinq debtinc profitrate  revenue yropen/selection = none;   
run;
/*????,????????*/
proc logistic inmodel=work.estimate1 ;
  score data= work.design2 out=work.scores2;
run;

/*??????*/
proc freq data = work.scores1; 
  title ‘data set smbl_train_impute prediction of classifiction situdation’;
  table F_bad*I_bad; 
run;
proc freq data = work.scores2; 
  title ‘data set smbl_validate _impute prediction of classifiction situdation’;
  table F_bad*I_bad; 
run;
/*?????????????????,????????*/

/*??lift?????*/
/*???*/
/*??*/
proc sort data = work.scores1 out = work.sorted_s1; by descending P_1; run;
/*??*/
data work.temp; 
  set work.sorted_s1; 
  group = ceil(_N_ /420);
run;
/*??????,????????p?-???;*/
data work.plot; 
  set work.temp; 
  by group;
  if first.group then sum =0; 
    if last.group then
      do;
        avg = (sum/420); 
        p = (100*avg)/(859/4200); 
    output; 
      end; 
    else sum + bad; 
run;
/*??*/
proc sgplot data = work.plot; 
  title"testing data set of LIFT";
  series x= group y = p / markers; 
run;

/*???*/
/*??*/
proc sort data = work.scores2 out = work.sorted_s2; by descending P_1; run;
/*??*/
data temp; 
  set work.sorted_s2; 
  group = ceil(_N_ /180);
run;
/*??????,????????p?-???;*/
data plot;
  set temp; 
  by group;
  if first.group then sum =0; 
    if last.group then
      do; 
        avg = (sum/180); 
        p = (100*avg)/(336/1800); 
      output; 
      end; 
    else sum + ????; 
run;
proc sgplot data = plot; *??;
  title"testing data set LIFT";
  series x= group y = p / markers; 
run;

/*??,??????,?????,???p????,?????????,?????????????;????????LIFT?????,
????,????????????*/

/*????
????????????????,?????????????
ln(p/(1-p)) = -2.3688 + ????1 * -1.1946 + ????3 * 0.2384 + ???? * 0.4188 + ??? * 0.1384+ ????? * -1.3416 + ??? * -0.00003 + ???? * -0.2255
????1???(?????1,?1;?????4,?-1;???????0)
????3???(?????2,?1;?????4,?-1;???????0)
???,p??????1????,????p??,?????????*/
